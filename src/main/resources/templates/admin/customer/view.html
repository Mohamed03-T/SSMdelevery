<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{admin/partials/head.html :: head(titlePage='SSMDelivery | Détails Client')}"></head>

<body>

<header th:replace="~{admin/partials/header.html :: header}"></header>

<aside th:replace="~{admin/partials/sidebar.html :: aside(currentPage='/admin/customers')}"></aside>

<main id="main" class="main">

    <div class="pagetitle">
        <h1>Détails du Client</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}">Admin</a></li>
                <li class="breadcrumb-item"><a th:href="@{/admin/customers}">Clients</a></li>
                <li class="breadcrumb-item active">Détails</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg-12">

                <div class="card">
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-tabs-bordered" id="borderedTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="info-tab" data-bs-toggle="tab" 
                                        data-bs-target="#bordered-info" type="button" role="tab" 
                                        aria-controls="info" aria-selected="true">
                                    <i class="bi bi-person"></i> Informations
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="edit-tab" data-bs-toggle="tab" 
                                        data-bs-target="#bordered-edit" type="button" role="tab" 
                                        aria-controls="edit" aria-selected="false">
                                    <i class="bi bi-pencil"></i> Modifier
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="orders-tab" data-bs-toggle="tab" 
                                        data-bs-target="#bordered-orders" type="button" role="tab" 
                                        aria-controls="orders" aria-selected="false">
                                    <i class="bi bi-box"></i> Commandes
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content pt-3" id="borderedTabContent">
                            
                            <!-- Tab Informations -->
                            <div class="tab-pane fade show active" id="bordered-info" role="tabpanel" aria-labelledby="info-tab">
                                <h5 class="card-title">Informations du Client</h5>
                                
                                <div class="row mb-4">
                                    <div class="col-lg-6">
                                        <table class="table table-borderless">
                                            <tbody>
                                                <tr>
                                                    <td class="fw-bold" style="width: 40%;">ID Client:</td>
                                                    <td th:text="${customer.id}">1</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Numéro Client:</td>
                                                    <td th:text="${customer.customerNumber}">CUST001</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Nom complet:</td>
                                                    <td th:text="${customer.firstName + ' ' + customer.lastName}">Mohamed Ali</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Email:</td>
                                                    <td th:text="${customer.email}">mohamed@example.com</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Téléphone:</td>
                                                    <td th:text="${customer.phoneNumber}">+213555123456</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">CIN:</td>
                                                    <td th:text="${customer.cin != null ? customer.cin : 'Non renseigné'}">123456789</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="col-lg-6">
                                        <table class="table table-borderless">
                                            <tbody>
                                                <tr>
                                                    <td class="fw-bold" style="width: 40%;">Date de naissance:</td>
                                                    <td th:text="${customer.dateOfBirth != null ? #dates.format(customer.dateOfBirth, 'dd/MM/yyyy') : 'Non renseigné'}">01/01/1990</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Statut:</td>
                                                    <td>
                                                        <span th:if="${customer.status != null and customer.status.name() == 'ACTIVE'}" class="badge bg-success">Actif</span>
                                                        <span th:if="${customer.status != null and customer.status.name() == 'EMAIL_NOT_VERIFIED'}" class="badge bg-warning">Email non vérifié</span>
                                                        <span th:if="${customer.status != null and customer.status.name() == 'LOCKED'}" class="badge bg-danger">Verrouillé</span>
                                                        <span th:if="${customer.status != null and customer.status.name() == 'EXPIRED'}" class="badge bg-secondary">Expiré</span>
                                                        <span th:if="${customer.status == null}" class="badge bg-secondary">Non défini</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Solde:</td>
                                                    <td th:text="${customer.balance != null ? customer.balance + ' DZD' : '0 DZD'}">0 DZD</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Date d'inscription:</td>
                                                    <td th:text="${customer.registeredAt != null ? #temporals.format(customer.registeredAt, 'dd/MM/yyyy HH:mm') : 'Non disponible'}">12/11/2025</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-bold">Email vérifié:</td>
                                                    <td>
                                                        <span th:if="${customer.verifiedAt != null}" class="badge bg-success">
                                                            <i class="bi bi-check-circle"></i> Vérifié le 
                                                            <span th:text="${#temporals.format(customer.verifiedAt, 'dd/MM/yyyy')}"></span>
                                                        </span>
                                                        <span th:unless="${customer.verifiedAt != null}" class="badge bg-warning">
                                                            <i class="bi bi-x-circle"></i> Non vérifié
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Adresse -->
                                <div th:if="${customer.address != null}">
                                    <h5 class="card-title">Adresse</h5>
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <td class="fw-bold" style="width: 20%;">Adresse complète:</td>
                                                <td th:text="${customer.address.address}">123 Rue Example</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Province:</td>
                                                <td th:text="${customer.address.city?.province?.name}">Alger</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Ville:</td>
                                                <td th:text="${customer.address.city?.name}">Alger Centre</td>
                                            </tr>
                                            <tr>
                                                <td class="fw-bold">Quartier:</td>
                                                <td th:text="${customer.address.area?.name ?: 'Non renseigné'}">Didouche Mourad</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tab Modifier -->
                            <div class="tab-pane fade" id="bordered-edit" role="tabpanel" aria-labelledby="edit-tab">
                                <h5 class="card-title">Modifier les informations</h5>

                                <form id="update_customer_form" th:action="@{/admin/customer/update/{id}(id=${customer.id})}" method="post">
                                    <input type="hidden" name="_csrf" th:value="${csrf_token}"/>

                                    <div class="row mb-3">
                                        <!-- Colonne gauche -->
                                        <div class="col-lg-6">
                                            
                                            <div class="row mb-3">
                                                <label for="firstName" class="col-sm-4 col-form-label">Prénom <span class="text-danger">*</span></label>
                                                <div class="col-sm-8">
                                                    <input type="text" name="firstName" id="firstName" class="form-control" 
                                                           th:value="${customer.firstName}" required>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label for="lastName" class="col-sm-4 col-form-label">Nom <span class="text-danger">*</span></label>
                                                <div class="col-sm-8">
                                                    <input type="text" name="lastName" id="lastName" class="form-control" 
                                                           th:value="${customer.lastName}" required>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label for="email" class="col-sm-4 col-form-label">Email <span class="text-danger">*</span></label>
                                                <div class="col-sm-8">
                                                    <input type="email" name="email" id="email" class="form-control" 
                                                           th:value="${customer.email}" required>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label for="phoneNumber" class="col-sm-4 col-form-label">Téléphone <span class="text-danger">*</span></label>
                                                <div class="col-sm-8">
                                                    <input type="text" name="phoneNumber" id="phoneNumber" class="form-control" 
                                                           th:value="${customer.phoneNumber}"
                                                           pattern="^(\+213|0)[5-7]\d{8}$" required>
                                                    <small class="text-muted">Format: +213555123456 ou 0555123456</small>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label for="cin" class="col-sm-4 col-form-label">CIN</label>
                                                <div class="col-sm-8">
                                                    <input type="text" name="cin" id="cin" class="form-control" 
                                                           th:value="${customer.cin}">
                                                </div>
                                            </div>

                                        </div>

                                        <!-- Colonne droite -->
                                        <div class="col-lg-6">
                                            
                                            <div class="row mb-3">
                                                <label for="dateOfBirth" class="col-sm-4 col-form-label">Date de naissance</label>
                                                <div class="col-sm-8">
                                                    <input type="date" name="dateOfBirth" id="dateOfBirth" class="form-control" 
                                                           th:value="${customer.dateOfBirth != null ? #dates.format(customer.dateOfBirth, 'yyyy-MM-dd') : ''}">
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label for="password" class="col-sm-4 col-form-label">Nouveau mot de passe</label>
                                                <div class="col-sm-8">
                                                    <input type="password" name="password" id="password" class="form-control" 
                                                           placeholder="Laisser vide pour ne pas changer">
                                                    <small class="text-muted">Laisser vide pour conserver l'ancien mot de passe</small>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label for="status" class="col-sm-4 col-form-label">Statut</label>
                                                <div class="col-sm-8">
                                                    <select name="status" id="status" class="form-select">
                                                        <option value="ACTIVE" th:selected="${customer.status != null and customer.status.name() == 'ACTIVE'}">Actif</option>
                                                        <option value="EMAIL_NOT_VERIFIED" th:selected="${customer.status != null and customer.status.name() == 'EMAIL_NOT_VERIFIED'}">Email non vérifié</option>
                                                        <option value="LOCKED" th:selected="${customer.status != null and customer.status.name() == 'LOCKED'}">Verrouillé</option>
                                                        <option value="EXPIRED" th:selected="${customer.status != null and customer.status.name() == 'EXPIRED'}">Expiré</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div class="row mb-3">
                                                <label for="image" class="col-sm-4 col-form-label">URL Image</label>
                                                <div class="col-sm-8">
                                                    <input type="url" name="image" id="image" class="form-control" 
                                                           th:value="${customer.image}" 
                                                           placeholder="https://example.com/image.jpg">
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-secondary" onclick="window.location.href='/admin/customers'">
                                                <i class="bi bi-x-circle"></i> Annuler
                                            </button>
                                            <button class="btn btn-primary" type="submit">
                                                <i class="bi bi-check-circle"></i> Enregistrer
                                            </button>
                                        </div>
                                    </div>

                                </form>
                            </div>

                            <!-- Tab Commandes -->
                            <div class="tab-pane fade" id="bordered-orders" role="tabpanel" aria-labelledby="orders-tab">
                                <h5 class="card-title">Historique des commandes</h5>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Fonctionnalité à venir...
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

</main>

<footer th:replace="~{admin/partials/footer.html :: footer}"></footer>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
</a>

<script src="/assets/vendor/apexcharts/apexcharts.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/chart.js/chart.umd.js"></script>
<script src="/assets/vendor/echarts/echarts.min.js"></script>
<script src="/assets/vendor/quill/quill.js"></script>
<script src="/assets/vendor/simple-datatables/simple-datatables.js"></script>
<script src="/assets/vendor/tinymce/tinymce.min.js"></script>
<script src="/assets/vendor/php-email-form/validate.js"></script>
<script src="/loading/js/main.js"></script>
<script src="/toaster/js/toaster.js"></script>
<script src="/assets/js/main.js"></script>

<script>
    document.getElementById('update_customer_form').addEventListener('submit', function(event) {
        event.preventDefault();

        let url = this.action;
        let formData = new FormData(this);
        $('#loader-wrapper').show();

        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            $('#loader-wrapper').hide();

            if (data.success) {
                showAlert({type: "success", message: data.message});
                setTimeout(() => {
                    location.reload(); // Reload to show updated data
                }, 1500);
            } else {
                showAlert({type: "error", message: data.message});

                if (data.error != null && Array.isArray(data.error)) {
                    // Clear previous validation errors
                    $('input, select, textarea').removeClass('not-valid-item');
                    
                    data.error.forEach(function (error) {
                        $('input[name="' + error.field + '"]').addClass('not-valid-item');
                        $('select[name="' + error.field + '"]').addClass('not-valid-item');
                    });
                }
            }

            console.log(data);
        })
        .catch(error => {
            $('#loader-wrapper').hide();
            showAlert({type: "error", message: "Erreur lors de la modification"});
            console.error('Error:', error);
        });
    });
</script>

</body>

</html>





