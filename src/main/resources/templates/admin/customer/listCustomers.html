<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="admin/partials/head.html :: head(titlePage='Delix | Clients')"></head>

<body>

<header th:replace="admin/partials/header.html :: header"></header>

<aside th:replace="admin/partials/sidebar.html :: aside(currentPage='/admin/customers')"></aside>

<main id="main" class="main">

    <div class="pagetitle">
        <h1>Liste des Clients</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}">Admin</a></li>
                <li class="breadcrumb-item">Clients</li>
                <li class="breadcrumb-item active">Liste</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg-12">

                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title">Tous les Clients</h5>
                            <a href="/admin/customer/add" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-1"></i> Ajouter un Client
                            </a>
                        </div>

                        <!-- Table with stripped rows -->
                        <table class="table datatable">
                            <thead>
                            <tr>
                                <th><b>N°</b></th>
                                <th>Nom Complet</th>
                                <th>Email</th>
                                <th>Téléphone</th>
                                <th>Statut</th>
                                <th>Date d'inscription</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="customer, iterStat : ${customers}" th:id="@{|row-${customer.id}|}">
                                <td th:text="${iterStat.count}">1</td>
                                <td>
                                    <span th:text="${customer.firstName + ' ' + customer.lastName}">Nom</span>
                                    <br>
                                    <small class="text-muted" th:if="${customer.customerNumber}" 
                                           th:text="'N° ' + ${customer.customerNumber}"></small>
                                </td>
                                <td th:text="${customer.email}">email@example.com</td>
                                <td th:text="${customer.phoneNumber}">+212600000000</td>
                                <td>
                                    <span th:if="${customer.status} == 'ACTIVE'" class="badge bg-success">Actif</span>
                                    <span th:if="${customer.status} == 'EMAIL_NOT_VERIFIED'" class="badge bg-warning">Email non vérifié</span>
                                    <span th:if="${customer.status} == 'LOCKED'" class="badge bg-danger">Verrouillé</span>
                                    <span th:if="${customer.status} == 'EXPIRED'" class="badge bg-secondary">Expiré</span>
                                </td>
                                <td th:text="${#temporals.format(customer.registeredAt, 'dd/MM/yyyy')}">01/01/2024</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a th:href="@{'/admin/customer/view/' + ${customer.id}}" 
                                           class="btn btn-sm btn-info" 
                                           title="Voir les détails">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a th:href="@{'/admin/customer/edit/' + ${customer.id}}" 
                                           class="btn btn-sm btn-warning" 
                                           title="Modifier">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <button type="button" 
                                                th:onclick="@{|deleteCustomer(${customer.id})|}" 
                                                class="btn btn-sm btn-danger" 
                                                title="Supprimer">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                        <!-- End Table with stripped rows -->

                        <div th:if="${customers == null or customers.isEmpty()}" class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Aucun client trouvé. <a href="/admin/customer/add">Ajouter le premier client</a>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModule" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title text-danger">Supprimer le client</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-4">
                    <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                    Êtes-vous sûr de vouloir supprimer ce client ? Cette action est irréversible.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Annuler
                    </button>
                    <button type="button" onclick="continueDeleting()" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i> Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

</main>

<footer th:replace="admin/partials/footer.html :: footer"></footer>

<a href="#" class="back-to-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
</a>

<script src="/assets/vendor/apexcharts/apexcharts.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/vendor/chart.js/chart.umd.js"></script>
<script src="/assets/vendor/echarts/echarts.min.js"></script>
<script src="/assets/vendor/quill/quill.js"></script>
<script src="/assets/vendor/simple-datatables/simple-datatables.js"></script>
<script src="/assets/vendor/tinymce/tinymce.min.js"></script>
<script src="/assets/vendor/php-email-form/validate.js"></script>
<script src="/loading/js/main.js"></script>
<script src="/toaster/js/toaster.js"></script>
<script src="/assets/js/main.js"></script>

<script>
    const showAlert = (data) => {
        let { type, message } = data;
        let autoClose = data.autoClose === undefined ? 3000 : data.autoClose;

        let toastContainer = document.createElement('div');
        toastContainer.classList.add('toast-container');
        var container = document.querySelector('.toast-container');
        if (typeof (container) != 'undefined' && container != null) return;
        document.body.appendChild(toastContainer);
        
        let icon;
        if(type == 'error') {
            icon = 'fa-circle-exclamation';
        } else if(type == 'success'){
            icon = 'fa-circle-check';
        } else if(type == 'warning'){
            icon = 'fa-triangle-exclamation';
        } else if(type == 'info'){
            icon = 'fa-circle-info';
        }

        let alert = `<div class="inAlert ${type}">
            <div class="wrapper">
                <div class="icon">
                    <i class="fa-solid ${icon}"></i>
                </div>
                <div class="details">
                    <div class="title">${type}</div>
                    <div class="message">${message}</div>
                </div>
            </div>
            <i class="fa-solid fa-xmark closeAlert"></i>
        </div>`;
        
        toastContainer.insertAdjacentHTML('afterbegin', alert);
        
        setTimeout(() => {
            var isAlert = document.querySelector('.inAlert');
            if (typeof (isAlert) != 'undefined' && isAlert != null) isAlert.classList.add('slide-in');
        }, 100);

        setTimeout(() => {
            var isAlert = document.querySelector('.inAlert');
            if (typeof (isAlert) != 'undefined' && isAlert != null) isAlert.classList.remove('slide-in');
            setTimeout(() => {
                document.querySelector('.inAlert').remove();
                removeToast();
            }, 100);
        }, autoClose);

        let closeBtn = document.querySelector('.closeAlert');
        closeBtn.addEventListener('click', () => {
            document.querySelector('.inAlert').classList.remove('slide-in');
            setTimeout(() => {
                document.querySelector('.inAlert').remove();
                removeToast();
            }, 100);
        });
    };

    const removeToast = () => {
        var container = document.querySelector('.toast-container');
        if (!container.hasChildNodes()) container.remove();
    };

    let customerIdForDelete = null;
    
    function deleteCustomer(id) {
        customerIdForDelete = id;
        $('#deleteModule').modal('show');
    }

    function continueDeleting() {
        $('#deleteModule').modal('hide');
        $('#loader-wrapper').show();
        
        fetch(`/admin/customer/delete/${customerIdForDelete}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            $('#loader-wrapper').hide();
            if (data.type === 'success') {
                $(`#row-${customerIdForDelete}`).remove();
                showAlert({type: data.type, message: data.message});
            } else {
                showAlert({type: 'error', message: data.message});
            }
        })
        .catch(error => {
            $('#loader-wrapper').hide();
            showAlert({type: 'error', message: 'Erreur lors de la suppression du client'});
            console.error('Error:', error);
        });
    }
</script>

</body>

</html>
